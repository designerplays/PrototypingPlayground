<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Jack Adventure</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Nunito', 'Arial', sans-serif;
            background: linear-gradient(180deg, #2d3f1f 0%, #1a1f13 40%, #0e0f0b 100%);
            color: #f7f5f2;
            overflow: auto;
            touch-action: manipulation;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 0 10px 16px;
        }

        #debug-button {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            padding: 8px 12px;
            font-size: 20px;
            border-radius: 3px;
            cursor: pointer;
            z-index: 1000;
            font-family: 'Courier New', monospace;
            line-height: 1;
        }

        #debug-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            padding: 30px;
            z-index: 2000;
            display: none;
            min-width: 250px;
        }

        #debug-popup.show {
            display: block;
        }

        #debug-popup-content {
            color: #fff;
            font-size: 14px;
            line-height: 1.6;
        }

        #debug-close {
            margin-top: 20px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            cursor: pointer;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            width: 100%;
        }

        #game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px 8px 16px;
            overflow-y: auto;
            max-width: 520px;
            margin: 0 auto;
            width: 100%;
            gap: 10px;
        }

        .panel {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.06), rgba(0, 0, 0, 0.25));
            border: 1px solid rgba(255, 255, 255, 0.14);
            border-radius: 12px;
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.35);
            backdrop-filter: blur(3px);
        }

        /* Encounter Info */
        #encounter-info {
            text-align: center;
            padding: 12px 8px 10px;
            border-radius: 18px;
            background: linear-gradient(180deg, rgba(77, 110, 59, 0.9), rgba(53, 76, 41, 0.9));
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: #f3f8ec;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.35);
            letter-spacing: 0.5px;
        }

        #encounter-name {
            font-size: 20px;
            font-weight: 800;
            text-transform: uppercase;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.35);
            margin-bottom: 4px;
        }

        #encounter-count {
            font-size: 12px;
            color: #d5e3c6;
            opacity: 0.9;
        }

        /* Enemies Row */
        #enemies-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .enemy-card {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.08), rgba(0, 0, 0, 0.35));
            border: 2px solid rgba(255, 148, 120, 0.65);
            border-radius: 14px;
            padding: 10px 12px;
            min-width: 130px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 14px 24px rgba(0, 0, 0, 0.35);
            position: relative;
        }

        .enemy-card::after {
            content: '';
            position: absolute;
            inset: 2px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.04);
            pointer-events: none;
        }

        .enemy-card.targeted {
            border-color: #ffe76a;
            box-shadow: 0 0 12px rgba(255, 231, 106, 0.8);
        }

        .enemy-card.dead {
            opacity: 0.3;
            pointer-events: none;
            background: rgba(80, 80, 80, 0.2);
            border-color: rgba(120, 120, 120, 0.4);
        }

        .enemy-name {
            font-weight: 800;
            font-size: 15px;
            margin-bottom: 6px;
            text-align: center;
            color: #ffe0c2;
        }

        .enemy-health-bar {
            background: rgba(0, 0, 0, 0.6);
            height: 14px;
            border-radius: 9px;
            overflow: hidden;
            margin-bottom: 6px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .enemy-health-fill {
            background: linear-gradient(90deg, #ff5f6d, #ffc371);
            height: 100%;
            transition: width 0.3s;
        }

        .enemy-health-text {
            font-size: 12px;
            text-align: center;
            margin-bottom: 6px;
            color: #f7e9dc;
        }

        .enemy-stats {
            font-size: 11px;
            color: #e8dcd0;
            text-align: center;
            display: flex;
            justify-content: center;
            gap: 8px;
        }

        /* Player Cards Area */
        #player-cards-area {
            background: linear-gradient(180deg, #402a1a 0%, #2f1d12 100%);
            border-radius: 14px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 8px;
            box-shadow: inset 0 2px 0 rgba(255, 255, 255, 0.08), 0 12px 18px rgba(0, 0, 0, 0.35);
            border: 1px solid rgba(0, 0, 0, 0.35);
        }

        #cards-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #f8e5d0;
            font-weight: 800;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        #cards-display {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .card {
            background: #fff;
            color: #000;
            width: 64px;
            height: 86px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 800;
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.35);
        }

        .card.red {
            color: #d62839;
        }

        #hand-total {
            font-size: 16px;
            font-weight: 800;
            color: #f5d7c4;
            text-align: right;
        }

        #hand-total.bust {
            color: #ff7b7b;
        }

        /* Player Stats */
        #player-stats {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.06), rgba(0, 0, 0, 0.35));
            border-radius: 14px;
            padding: 12px 14px 10px;
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.35);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .stat-label {
            font-size: 13px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            font-weight: 800;
            letter-spacing: 0.5px;
        }

        .stat-bar {
            background: rgba(0, 0, 0, 0.7);
            height: 18px;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .stat-bar-fill {
            height: 100%;
            transition: width 0.3s;
        }

        .health-bar-fill {
            background: linear-gradient(90deg, #2af598, #08aeea);
            box-shadow: inset 0 0 8px rgba(255, 255, 255, 0.3);
        }

        .stat-bar-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            font-weight: 800;
            color: #fefefe;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        .stat-bar-container {
            margin-bottom: 2px;
        }

        /* Tracker row */
        #tracker-row {
            display: grid;
            grid-template-columns: 1.2fr 1.4fr 0.8fr;
            gap: 10px;
            align-items: stretch;
        }

        .tracker-card {
            background: linear-gradient(180deg, #f5f1ec, #d9c8b6);
            border-radius: 12px;
            padding: 10px 12px;
            color: #2c1b16;
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.35);
            border: 2px solid #b48a63;
        }

        #deck-widget {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-weight: 800;
            cursor: pointer;
            text-align: left;
        }

        #deck-widget:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #deck-count {
            font-size: 22px;
        }

        .tracker-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            color: #5a3a2a;
        }

        .tracker-sub {
            font-size: 11px;
            color: #6c4d3a;
        }

        #thermometer-card {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        #thermometer-bar {
            background: #fff7e8;
            border-radius: 999px;
            height: 18px;
            overflow: hidden;
            border: 1px solid #cfa074;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #thermometer-fill {
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, #6dd5ed 0%, #f09819 60%, #ed213a 100%);
            transition: width 0.3s ease;
        }

        #thermometer-value {
            font-size: 18px;
            font-weight: 800;
            color: #3a2419;
            text-align: right;
        }

        #gem-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        #gem-count {
            font-size: 20px;
            font-weight: 800;
        }

        .gem-icon {
            font-size: 26px;
        }

        /* Action Buttons */
        #action-buttons {
            display: flex;
            gap: 12px;
        }

        .action-button {
            flex: 1;
            padding: 14px 8px 12px;
            font-size: 16px;
            font-weight: 800;
            border: none;
            border-radius: 14px;
            cursor: pointer;
            font-family: 'Nunito', 'Arial', sans-serif;
            transition: all 0.2s;
            touch-action: manipulation;
            color: #2c1b16;
            box-shadow: 0 12px 18px rgba(0, 0, 0, 0.35);
            text-transform: uppercase;
            letter-spacing: 0.6px;
        }

        #charge-button {
            background: linear-gradient(180deg, #f9db6d 0%, #f5b13d 100%);
            border: 2px solid #f5c15c;
        }

        #charge-button:active {
            transform: scale(0.97);
        }

        #attack-button {
            background: linear-gradient(180deg, #ff7b7b 0%, #e5483b 100%);
            border: 2px solid #ff9b8f;
            color: #fff6f0;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.25);
        }

        #attack-button:active {
            transform: scale(0.97);
        }

        .action-button:disabled {
            opacity: 0.55;
            cursor: not-allowed;
        }

        /* Feedback Messages */
        #feedback-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px 50px;
            border-radius: 10px;
            font-size: 24px;
            font-weight: bold;
            z-index: 100;
            display: none;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.3);
            max-width: 80%;
        }

        .damage-popup {
            position: absolute;
            font-size: 24px;
            font-weight: bold;
            color: #ff4444;
            animation: popup 1s ease-out forwards;
            pointer-events: none;
            z-index: 50;
        }

        @keyframes popup {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-50px);
            }
        }

        /* Game Over Screen */
        #game-over-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 20px;
        }

        #game-over-title {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        #game-over-message {
            font-size: 18px;
            margin-bottom: 30px;
            text-align: center;
        }

        #restart-button {
            padding: 15px 40px;
            font-size: 20px;
            font-weight: bold;
            background: linear-gradient(135deg, #44ff44, #66ff66);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            color: #000;
        }

        #restart-button:active {
            transform: scale(0.95);
        }


        .hit-flash {
            animation: hitFlash 0.3s ease-out;
        }

        @keyframes hitFlash {
            0%, 100% {
                background: rgba(0, 0, 0, 0.5);
            }
            50% {
                background: rgba(255, 0, 0, 0.5);
            }
        }

        .enemy-attack-flash {
            animation: enemyAttackFlash 0.5s ease-out;
        }

        @keyframes enemyAttackFlash {
            0%, 100% {
                background: rgba(200, 50, 50, 0.3);
                border-color: rgba(255, 100, 100, 0.5);
            }
            50% {
                background: rgba(255, 0, 0, 0.8);
                border-color: rgba(255, 50, 50, 1);
            }
        }

        .enemy-cooldown-flash {
            animation: enemyCooldownFlash 0.5s ease-out;
        }

        @keyframes enemyCooldownFlash {
            0%, 100% {
                background: rgba(200, 50, 50, 0.3);
                border-color: rgba(255, 100, 100, 0.5);
            }
            50% {
                background: rgba(0, 100, 255, 0.6);
                border-color: rgba(0, 150, 255, 1);
            }
        }

        /* Mobile optimizations for very small screens */
        @media (max-height: 600px) {
            #game-container {
                padding: 6px;
                gap: 6px;
            }

            #encounter-info {
                padding: 4px 6px;
            }

            #encounter-name {
                font-size: 14px;
                margin-bottom: 2px;
            }

            #encounter-count {
                font-size: 11px;
            }

            .enemy-card {
                padding: 4px 6px;
                min-width: 80px;
            }

            .enemy-name {
                font-size: 12px;
                margin-bottom: 3px;
            }

            .enemy-health-bar {
                height: 8px;
                margin-bottom: 2px;
            }

            .enemy-health-text {
                font-size: 9px;
                margin-bottom: 2px;
            }

            .enemy-stats {
                font-size: 8px;
            }

            #player-cards-area {
                padding: 6px;
                min-height: 75px;
            }

            .card {
                width: 40px;
                height: 55px;
                font-size: 14px;
            }

            #hand-total {
                font-size: 14px;
                margin-bottom: 4px;
            }


            .stat-bar-container {
                margin-bottom: 4px;
            }

            .stat-label {
                font-size: 10px;
                margin-bottom: 2px;
            }

            .stat-bar {
                height: 14px;
            }

            .stat-bar-text {
                font-size: 10px;
            }

            .action-button {
                padding: 10px 6px;
                font-size: 13px;
            }

            #tracker-row {
                grid-template-columns: 1fr 1fr;
                gap: 6px;
            }
        }

        @media (max-height: 500px) {
            #game-container {
                padding: 4px;
                gap: 4px;
            }

            #player-cards-area {
                min-height: 60px;
            }

            .action-button {
                padding: 8px 6px;
                font-size: 12px;
            }

            #tracker-row {
                grid-template-columns: 1fr;
            }
        }

        /* Deck Popup */
        #deck-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            padding: 20px;
            z-index: 2000;
            display: none;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }

        #deck-popup.show {
            display: block;
        }

        #deck-popup-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }

        #deck-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .deck-card {
            background: #fff;
            color: #000;
            width: 50px;
            height: 70px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .deck-card.red {
            color: #d00;
        }

        .deck-card.played {
            opacity: 0.4;
            background: transparent;
            border: 2px dotted #fff;
        }

        #deck-close {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            cursor: pointer;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            width: 100%;
        }

        /* Reward Popup */
        #reward-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid rgba(255, 215, 0, 0.5);
            border-radius: 10px;
            padding: 30px;
            z-index: 2100;
            display: none;
            max-width: 90%;
        }

        #reward-popup.show {
            display: block;
        }

        #reward-popup-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            color: #ffd700;
        }

        #reward-cards {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .reward-card-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .reward-card {
            background: #fff;
            color: #000;
            width: 60px;
            height: 84px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(255, 215, 0, 0.3);
            border: 2px solid #ffd700;
        }

        .reward-card.red {
            color: #d00;
        }

        .pick-button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #000;
            transition: all 0.2s;
        }

        .pick-button:hover {
            transform: scale(1.05);
        }

        .pick-button:active {
            transform: scale(0.95);
        }

    </style>
</head>
<body>
    <div id="debug-button">üêõ</div>

    <div id="debug-popup">
        <div id="debug-popup-content">
            <strong>Jack Adventure</strong><br>
            Version: 1.1<br>
            A blackjack dungeon crawler
        </div>
        <button id="debug-close">Close</button>
    </div>

    <div id="game-container">
        <!-- Encounter Info -->
        <div id="encounter-info" class="panel">
            <div id="encounter-name">Loading...</div>
            <div id="encounter-count"></div>
        </div>

        <!-- Enemies Row -->
        <div id="enemies-row"></div>

        <!-- Player Health -->
        <div id="player-stats">
            <div class="stat-bar-container">
                <div class="stat-label">
                    <span>Health</span>
                    <span id="health-text">50 / 50</span>
                </div>
                <div class="stat-bar">
                    <div class="health-bar-fill stat-bar-fill" id="health-bar" style="width: 100%"></div>
                    <div class="stat-bar-text" id="health-text-overlay">50 / 50</div>
                </div>
            </div>
        </div>

        <!-- Player Cards Area -->
        <div id="player-cards-area">
            <div id="cards-header">
                <span>Cards in Play</span>
                <span id="hand-total">Limit: 0</span>
            </div>
            <div id="cards-display"></div>
        </div>

        <!-- Tracker row -->
        <div id="tracker-row">
            <button id="deck-widget" class="tracker-card" type="button">
                <div class="tracker-title">Deck</div>
                <div id="deck-count">0/0 Cards</div>
                <div class="tracker-sub">Tap to view</div>
            </button>

            <div id="thermometer-card" class="tracker-card">
                <div class="tracker-title">Thermometer</div>
                <div id="thermometer-bar">
                    <div id="thermometer-fill"></div>
                </div>
                <div id="thermometer-value">0 / 21</div>
                <div class="tracker-sub">Limit 21</div>
            </div>

            <div id="gem-card" class="tracker-card">
                <div class="tracker-title">Gems</div>
                <div class="gem-icon">üíé</div>
                <div id="gem-count">0</div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div id="action-buttons">
            <button id="charge-button" class="action-button">
                Deal
            </button>
            <button id="attack-button" class="action-button">
                Attack
            </button>
        </div>
    </div>

    <!-- Feedback Message -->
    <div id="feedback-message"></div>

    <!-- Game Over Screen -->
    <div id="game-over-screen">
        <div id="game-over-title">GAME OVER</div>
        <div id="game-over-message"></div>
        <button id="restart-button">RESTART</button>
    </div>

    <!-- Deck Popup -->
    <div id="deck-popup">
        <div id="deck-popup-title">Your Deck</div>
        <div id="deck-grid"></div>
        <button id="deck-close">Close</button>
    </div>

    <!-- Reward Popup -->
    <div id="reward-popup">
        <div id="reward-popup-title">Choose Your Reward!</div>
        <div id="reward-cards"></div>
    </div>

    <script>
        // Game State
        const GameState = {
            config: null,
            encounters: null,
            startingDeck: null,
            player: {
                currentHealth: 0,
                maxHealth: 0,
                deck: [],
                hand: [],
                playedCards: [],
                fullDeck: []
            },
            currentEncounterIndex: 0,
            enemies: [],
            targetEnemyIndex: 0,
            gameOver: false,
            hasChargedThisTurn: false,
            showingRewards: false,
            gems: 25
        };

        // Card Suits and Ranks
        const SUITS = ['‚ô†', '‚ô•', '‚ô¶', '‚ô£'];
        const RANKS = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];

        // Initialize Game
        async function initGame() {
            try {
                // Load config files
                const configResponse = await fetch('GameConfig.json');
                GameState.config = await configResponse.json();

                const encountersResponse = await fetch('Encounters.json');
                GameState.encounters = await encountersResponse.json();

                const startingDeckResponse = await fetch('StartingDeck.json');
                GameState.startingDeck = await startingDeckResponse.json();

                // Initialize player
                GameState.player.maxHealth = GameState.config.playerStartingHealth;
                GameState.player.currentHealth = GameState.config.playerStartingHealth;

                // Start first encounter
                GameState.currentEncounterIndex = 0;
                startEncounter();
            } catch (error) {
                console.error('Error loading game data:', error);
                showFeedback('Error loading game data');
            }
        }

        // Create deck from fullDeck (includes starting deck + reward cards)
        function createDeckFromFullDeck() {
            const deck = [];

            // Copy all cards from fullDeck
            for (let card of GameState.player.fullDeck) {
                deck.push({ rank: card.rank, suit: card.suit });
            }

            return shuffleDeck(deck);
        }

        function shuffleDeck(deck) {
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            return deck;
        }

        // Sort cards by suit then value
        function sortCards(cards) {
            const suitOrder = { '‚ô†': 0, '‚ô£': 1, '‚ô•': 2, '‚ô¶': 3 };
            const valueOrder = { 'A': 1, '2': 2, '3': 3, '4': 4, '5': 5, '6': 6, '7': 7, '8': 8, '9': 9, '10': 10, 'J': 11, 'Q': 12, 'K': 13 };

            return cards.sort((a, b) => {
                const suitA = suitOrder[a.suit];
                const suitB = suitOrder[b.suit];

                if (suitA !== suitB) {
                    return suitA - suitB;
                }

                const valueA = valueOrder[a.rank];
                const valueB = valueOrder[b.rank];

                return valueA - valueB;
            });
        }

        // Calculate hand value (blackjack rules)
        function calculateHandValue(hand) {
            let total = 0;
            let aces = 0;

            for (let card of hand) {
                if (card.rank === 'A') {
                    aces++;
                    total += 11;
                } else if (['J', 'Q', 'K'].includes(card.rank)) {
                    total += 10;
                } else {
                    total += parseInt(card.rank);
                }
            }

            // Adjust for aces
            while (total > 21 && aces > 0) {
                total -= 10;
                aces--;
            }

            return total;
        }

        // Start new encounter
        function startEncounter() {
            if (GameState.currentEncounterIndex >= GameState.encounters.encounters.length) {
                // Victory!
                endGame(true, 'You cleared the dungeon!');
                return;
            }

            const encounter = GameState.encounters.encounters[GameState.currentEncounterIndex];

            // Initialize fullDeck if this is first encounter
            if (GameState.currentEncounterIndex === 0 && GameState.player.fullDeck.length === 0) {
                // Load starting deck from StartingDeck.json
                for (let card of GameState.startingDeck.cards) {
                    GameState.player.fullDeck.push({ rank: card.value, suit: card.suit });
                }
            }

            // Create deck from fullDeck (includes starting deck + reward cards)
            // This shuffles all cards (starting deck + rewards) back into the deck
            GameState.player.deck = createDeckFromFullDeck();
            GameState.player.hand = [];
            GameState.player.playedCards = [];
            GameState.hasChargedThisTurn = false;
            GameState.showingRewards = false;

            // Initialize enemies
            GameState.enemies = encounter.enemies.map(enemyTemplate => ({
                ...enemyTemplate,
                currentHealth: enemyTemplate.maxHealth,
                cooldownCounter: enemyTemplate.attackCooldown
            }));

            // Set target to first enemy
            GameState.targetEnemyIndex = 0;

            updateUI();
        }

        // Player action: Charge
        function charge() {
            if (GameState.gameOver) return;

            if (GameState.player.deck.length === 0) {
                // Deck exhausted
                endGame(false, 'You ran out of cards!');
                return;
            }

            // Draw a card
            const card = GameState.player.deck.pop();
            GameState.player.hand.push(card);

            // Track as played card
            GameState.player.playedCards.push(card);

            // Mark that player has charged this turn
            GameState.hasChargedThisTurn = true;

            updateUI();

            // Check for auto-bust
            const handValue = calculateHandValue(GameState.player.hand);
            if (handValue > 21) {
                // Auto-bust - show message and proceed to enemy turn
                setTimeout(() => {
                    showFeedback('BUST!', 800);

                    // After bust message, enemies attack and clear hand
                    setTimeout(() => {
                        enemiesAttack();

                        // Clear hand for next turn
                        GameState.player.hand = [];
                        GameState.hasChargedThisTurn = false;
                        updateUI();

                        // Check if player died
                        if (GameState.player.currentHealth <= 0) {
                            endGame(false, 'You died!');
                        }
                    }, 800);
                }, 100);
            }
        }

        // Player action: Attack
        function attack() {
            if (GameState.gameOver) return;

            const handValue = calculateHandValue(GameState.player.hand);
            const isBust = handValue > 21;

            if (isBust) {
                // Bust - no damage or healing
                showFeedback('BUST!', 800);
            } else {
                // Separate cards by suit
                const spadeCards = GameState.player.hand.filter(card => card.suit === '‚ô†');
                const heartCards = GameState.player.hand.filter(card => card.suit === '‚ô•');

                // Calculate damage from spade cards
                const damageAmount = calculateHandValue(spadeCards);

                // Calculate healing from heart cards
                const healAmount = calculateHandValue(heartCards);

                // Deal damage to target enemy if there are spade cards
                if (damageAmount > 0) {
                    const targetEnemy = GameState.enemies[GameState.targetEnemyIndex];
                    targetEnemy.currentHealth = Math.max(0, targetEnemy.currentHealth - damageAmount);

                    // Show damage popup
                    showDamagePopup(GameState.targetEnemyIndex, damageAmount);

                    // Check if enemy died
                    if (targetEnemy.currentHealth <= 0) {
                        // Move target to next live enemy
                        const nextLiveEnemy = findNextLiveEnemy();
                        if (nextLiveEnemy !== -1) {
                            GameState.targetEnemyIndex = nextLiveEnemy;
                        }
                    }
                }

                // Heal player if there are heart cards
                if (healAmount > 0) {
                    const oldHealth = GameState.player.currentHealth;
                    GameState.player.currentHealth = Math.min(
                        GameState.player.maxHealth,
                        GameState.player.currentHealth + healAmount
                    );
                    const actualHeal = GameState.player.currentHealth - oldHealth;

                    // Show heal feedback
                    if (actualHeal > 0) {
                        showFeedback(`+${actualHeal} HP`, 800);
                    }
                }
            }

            updateUI();

            // Check if all enemies are dead
            if (GameState.enemies.every(e => e.currentHealth <= 0)) {
                // Encounter cleared!
                GameState.gems += 5;
                updateUI();
                setTimeout(() => {
                    showFeedback('Encounter Cleared!', 1500);
                    setTimeout(() => {
                        showRewardPopup();
                    }, 1500);
                }, 500);
                return;
            }

            // Enemies attack
            setTimeout(() => {
                enemiesAttack();

                // Clear hand for next turn
                GameState.player.hand = [];
                GameState.hasChargedThisTurn = false;
                updateUI();

                // Check if player died
                if (GameState.player.currentHealth <= 0) {
                    endGame(false, 'You died!');
                }
            }, 800);
        }

        // Enemies attack (sequentially from left to right)
        async function enemiesAttack() {
            for (let i = 0; i < GameState.enemies.length; i++) {
                const enemy = GameState.enemies[i];

                if (enemy.currentHealth <= 0) continue;

                enemy.cooldownCounter--;

                if (enemy.cooldownCounter <= 0) {
                    // Enemy attacks!
                    // Flash the enemy red
                    await flashEnemy(i, 'attack');

                    // Deal damage to player
                    GameState.player.currentHealth = Math.max(0, GameState.player.currentHealth - enemy.attackPower);

                    // Show damage to player
                    showPlayerDamage(enemy.attackPower);

                    // Update UI to show HP decrease
                    updateUI();

                    // Reset cooldown
                    enemy.cooldownCounter = enemy.attackCooldown;

                    // Wait a bit before next enemy
                    await new Promise(resolve => setTimeout(resolve, 300));
                } else {
                    // Enemy is on cooldown, flash blue
                    await flashEnemy(i, 'cooldown');

                    // Update UI to show cooldown decrease
                    updateUI();

                    // Wait a bit before next enemy
                    await new Promise(resolve => setTimeout(resolve, 300));
                }
            }

            updateUI();
        }

        // Flash enemy card with animation
        function flashEnemy(enemyIndex, type) {
            return new Promise((resolve) => {
                const enemiesRow = document.getElementById('enemies-row');
                const enemyCard = enemiesRow.children[enemyIndex];

                if (enemyCard) {
                    const className = type === 'attack' ? 'enemy-attack-flash' : 'enemy-cooldown-flash';
                    enemyCard.classList.add(className);

                    setTimeout(() => {
                        enemyCard.classList.remove(className);
                        resolve();
                    }, 500);
                } else {
                    resolve();
                }
            });
        }


        // Update UI
        function updateUI() {
            // Encounter info
            const encounter = GameState.encounters.encounters[GameState.currentEncounterIndex];
            document.getElementById('encounter-name').textContent = encounter.name;
            document.getElementById('encounter-count').textContent =
                `(${GameState.currentEncounterIndex + 1}/${GameState.encounters.encounters.length})`;

            // Enemies
            const enemiesRow = document.getElementById('enemies-row');
            enemiesRow.innerHTML = '';

            GameState.enemies.forEach((enemy, index) => {
                const enemyCard = document.createElement('div');
                enemyCard.className = 'enemy-card';
                if (index === GameState.targetEnemyIndex && enemy.currentHealth > 0) {
                    enemyCard.classList.add('targeted');
                }
                if (enemy.currentHealth <= 0) {
                    enemyCard.classList.add('dead');
                }

                const healthPercent = (enemy.currentHealth / enemy.maxHealth) * 100;

                enemyCard.innerHTML = `
                    <div class="enemy-name">${enemy.name}</div>
                    <div class="enemy-health-bar">
                        <div class="enemy-health-fill" style="width: ${healthPercent}%"></div>
                    </div>
                    <div class="enemy-health-text">${enemy.currentHealth} / ${enemy.maxHealth}</div>
                    <div class="enemy-stats">‚öîÔ∏è ${enemy.attackPower} | üîÅ ${enemy.cooldownCounter}</div>
                `;

                enemyCard.addEventListener('click', () => selectTarget(index));
                enemiesRow.appendChild(enemyCard);
            });

            // Player cards
            const cardsDisplay = document.getElementById('cards-display');
            cardsDisplay.innerHTML = '';

            GameState.player.hand.forEach(card => {
                const cardElement = document.createElement('div');
                cardElement.className = 'card';
                if (card.suit === '‚ô•' || card.suit === '‚ô¶') {
                    cardElement.classList.add('red');
                }
                cardElement.textContent = `${card.rank}${card.suit}`;
                cardsDisplay.appendChild(cardElement);
            });

            // Hand total
            const handValue = calculateHandValue(GameState.player.hand);
            const handTotal = document.getElementById('hand-total');
            const bustLimit = GameState.config.bustLimit;
            handTotal.textContent = `Limit: ${handValue}/${bustLimit}`;
            handTotal.className = handValue > bustLimit ? 'bust' : '';

            // Thermometer
            const thermometerFill = document.getElementById('thermometer-fill');
            const thermometerValue = document.getElementById('thermometer-value');
            const thermometerPercent = Math.min(100, (handValue / bustLimit) * 100);
            thermometerFill.style.width = `${thermometerPercent}%`;
            thermometerValue.textContent = `${handValue} / ${bustLimit}`;

            // Deck info
            document.getElementById('deck-count').textContent =
                `${GameState.player.deck.length}/${GameState.player.fullDeck.length} Cards`;

            // Gems
            document.getElementById('gem-count').textContent = GameState.gems;

            // Health bar
            const healthPercent = (GameState.player.currentHealth / GameState.player.maxHealth) * 100;
            document.getElementById('health-bar').style.width = `${healthPercent}%`;
            document.getElementById('health-text').textContent =
                `${GameState.player.currentHealth} / ${GameState.player.maxHealth}`;
            document.getElementById('health-text-overlay').textContent =
                `${GameState.player.currentHealth} / ${GameState.player.maxHealth}`;

            // Enable/disable buttons
            const attackButton = document.getElementById('attack-button');
            const chargeButton = document.getElementById('charge-button');
            const deckWidget = document.getElementById('deck-widget');

            // Disable all action buttons when showing rewards
            if (GameState.showingRewards) {
                attackButton.disabled = true;
                chargeButton.disabled = true;
                deckWidget.disabled = true;
            } else {
                // Normal button state: attack button based on whether player has charged
                attackButton.disabled = !GameState.hasChargedThisTurn;
                chargeButton.disabled = false;
                deckWidget.disabled = false;
            }
        }

        // Select target enemy
        function selectTarget(index) {
            if (GameState.enemies[index].currentHealth > 0) {
                GameState.targetEnemyIndex = index;
                updateUI();
            }
        }

        // Find next live enemy (left to right)
        function findNextLiveEnemy() {
            // Start from the beginning and find the first live enemy
            for (let i = 0; i < GameState.enemies.length; i++) {
                if (GameState.enemies[i].currentHealth > 0) {
                    return i;
                }
            }
            return -1; // No live enemies
        }

        // Show feedback message
        function showFeedback(message, duration = 1000) {
            const feedbackElement = document.getElementById('feedback-message');
            feedbackElement.textContent = message;
            feedbackElement.style.display = 'block';

            setTimeout(() => {
                feedbackElement.style.display = 'none';
            }, duration);
        }

        // Show damage popup
        function showDamagePopup(enemyIndex, damage) {
            const enemiesRow = document.getElementById('enemies-row');
            const enemyCard = enemiesRow.children[enemyIndex];

            if (enemyCard) {
                const popup = document.createElement('div');
                popup.className = 'damage-popup';
                popup.textContent = `-${damage}`;
                popup.style.position = 'absolute';
                popup.style.left = '50%';
                popup.style.top = '50%';

                enemyCard.style.position = 'relative';
                enemyCard.appendChild(popup);

                setTimeout(() => popup.remove(), 1000);
            }
        }

        // Show player damage
        function showPlayerDamage(damage) {
            const healthBar = document.querySelector('.stat-bar');
            healthBar.classList.add('hit-flash');
            setTimeout(() => healthBar.classList.remove('hit-flash'), 300);
        }

        // End game
        function endGame(victory, message) {
            GameState.gameOver = true;

            const gameOverScreen = document.getElementById('game-over-screen');
            const gameOverTitle = document.getElementById('game-over-title');
            const gameOverMessage = document.getElementById('game-over-message');

            if (victory) {
                gameOverTitle.textContent = 'VICTORY!';
                gameOverTitle.style.color = '#44ff44';
            } else {
                gameOverTitle.textContent = 'GAME OVER';
                gameOverTitle.style.color = '#ff4444';
            }

            gameOverMessage.textContent = message;
            gameOverScreen.style.display = 'flex';
        }

        // Show Deck Popup
        function showDeckPopup() {
            const deckGrid = document.getElementById('deck-grid');
            deckGrid.innerHTML = '';

            // Get all cards in the full deck and sort them
            const sortedDeck = sortCards([...GameState.player.fullDeck]);

            sortedDeck.forEach(card => {
                const cardElement = document.createElement('div');
                cardElement.className = 'deck-card';

                // Check if card is played
                const isPlayed = GameState.player.playedCards.some(
                    playedCard => playedCard.rank === card.rank && playedCard.suit === card.suit
                );

                if (isPlayed) {
                    cardElement.classList.add('played');
                }

                if (card.suit === '‚ô•' || card.suit === '‚ô¶') {
                    cardElement.classList.add('red');
                }

                cardElement.textContent = `${card.rank}${card.suit}`;
                deckGrid.appendChild(cardElement);
            });

            document.getElementById('deck-popup').classList.add('show');
        }

        function hideDeckPopup() {
            document.getElementById('deck-popup').classList.remove('show');
        }

        // Show Reward Popup
        function showRewardPopup() {
            const encounter = GameState.encounters.encounters[GameState.currentEncounterIndex];
            const rewardCards = document.getElementById('reward-cards');
            rewardCards.innerHTML = '';

            encounter.rewards.forEach((rewardCard, index) => {
                const container = document.createElement('div');
                container.className = 'reward-card-container';

                const cardElement = document.createElement('div');
                cardElement.className = 'reward-card';

                if (rewardCard.suit === '‚ô•' || rewardCard.suit === '‚ô¶') {
                    cardElement.classList.add('red');
                }

                cardElement.textContent = `${rewardCard.value}${rewardCard.suit}`;

                const pickButton = document.createElement('button');
                pickButton.className = 'pick-button';
                pickButton.textContent = 'Pick';
                pickButton.addEventListener('click', () => selectReward(index));

                container.appendChild(cardElement);
                container.appendChild(pickButton);
                rewardCards.appendChild(container);
            });

            // Set flag and disable buttons
            GameState.showingRewards = true;
            updateUI();

            document.getElementById('reward-popup').classList.add('show');
        }

        function hideRewardPopup() {
            document.getElementById('reward-popup').classList.remove('show');

            // Clear flag and re-enable buttons
            GameState.showingRewards = false;
            updateUI();
        }

        // Select reward card
        function selectReward(index) {
            const encounter = GameState.encounters.encounters[GameState.currentEncounterIndex];
            const selectedCard = encounter.rewards[index];

            // Add card to full deck
            GameState.player.fullDeck.push({
                rank: selectedCard.value,
                suit: selectedCard.suit
            });

            // Hide popup
            hideRewardPopup();

            // Move to next encounter
            GameState.currentEncounterIndex++;
            startEncounter();
        }

        // Restart game
        function restartGame() {
            GameState.gameOver = false;
            GameState.currentEncounterIndex = 0;
            GameState.player.currentHealth = GameState.config.playerStartingHealth;
            GameState.player.fullDeck = [];
            GameState.gems = 25;

            document.getElementById('game-over-screen').style.display = 'none';

            startEncounter();
        }

        // Event Listeners
        document.getElementById('charge-button').addEventListener('click', charge);
        document.getElementById('attack-button').addEventListener('click', attack);
        document.getElementById('restart-button').addEventListener('click', restartGame);
        document.getElementById('deck-widget').addEventListener('click', showDeckPopup);
        document.getElementById('deck-close').addEventListener('click', hideDeckPopup);

        // Debug popup
        document.getElementById('debug-button').addEventListener('click', () => {
            document.getElementById('debug-popup').classList.toggle('show');
        });

        document.getElementById('debug-close').addEventListener('click', () => {
            document.getElementById('debug-popup').classList.remove('show');
        });

        // Initialize game on load
        window.addEventListener('load', initGame);
    </script>
</body>
</html>
